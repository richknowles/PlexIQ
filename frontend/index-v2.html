<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlexIQ v2 - AI-Powered Media Management</title>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles-v2.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-film"></i>
                        <div class="logo-text">
                            <h1>PlexIQ</h1>
                            <div class="team-branding">
                                <span class="team-name">Team Hotdog üå≠</span>
                                <span class="team-credit">Made with MUSTARD by Richard & Emmett Knowles</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button @click="refreshAnalysis" class="btn btn-primary" :disabled="isAnalyzing">
                            <i class="fas fa-sync-alt" :class="{ 'fa-spin': isAnalyzing }"></i>
                            {{ isAnalyzing ? 'Analyzing...' : 'Refresh Analysis' }}
                        </button>
                        <button @click="clearCache" class="btn btn-secondary">
                            <i class="fas fa-trash"></i>
                            Clear Cache
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Backup Disclaimer Banner -->
        <div class="disclaimer-banner">
            <div class="container">
                <i class="fas fa-exclamation-triangle"></i>
                <span><strong>Important:</strong> PlexIQ does not backup your media. All deletions are permanent and unrecoverable. Back up your collection before deleting!</span>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main">
            <div class="container">

                <!-- Analysis in Progress -->
                <div v-if="isAnalyzing" class="analysis-progress">
                    <div class="progress-card">
                        <h2>{{ analysisStatus.current_step || 'Preparing analysis...' }}</h2>
                        <div class="progress-bar-container">
                            <div class="progress-bar" :style="{ width: analysisStatus.progress + '%' }"></div>
                        </div>
                        <p class="progress-text">{{ analysisStatus.progress }}%</p>
                        <p class="progress-info" v-if="analysisStatus.total">
                            Processing {{ analysisStatus.progress }} of {{ analysisStatus.total }} movies
                        </p>
                    </div>
                </div>

                <!-- Error State -->
                <div v-if="error" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>{{ error }}</p>
                </div>

                <!-- Stats Dashboard -->
                <div v-if="stats && !isAnalyzing" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-film"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.total_movies }}</h3>
                            <p>Total Movies</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.total_size_gb.toFixed(1) }} GB</h3>
                            <p>Total Storage</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-eye-slash"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ stats.never_watched }}</h3>
                            <p>Never Watched</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-hdd"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="recoverable-space">{{ getRecoverableSpace() }} GB</h3>
                            <p>Recoverable Space</p>
                            <span class="stat-subtext">(Top {{ getRecoverableCount() }} movies)</span>
                        </div>
                    </div>

                    <div class="stat-card untouchables-card" @click="showUntouchablesModal = true">
                        <div class="stat-icon protected">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ untouchables.length }}</h3>
                            <p>The Untouchables</p>
                            <span class="stat-subtext">Protected movies</span>
                        </div>
                    </div>
                </div>

                <!-- Filters with Enhanced Slider -->
                <div v-if="movies.length > 0 && !isAnalyzing" class="filters-section">
                    <div class="card">
                        <h2><i class="fas fa-sliders-h"></i> Filters & Selection</h2>
                        <div class="filters">
                            <div class="filter-group slider-group">
                                <label>Delete Score Threshold:</label>
                                <div class="slider-container">
                                    <span class="slider-label">{{ filters.minScore }}</span>
                                    <div class="custom-slider">
                                        <input type="range" v-model="filters.minScore" min="0" max="100" step="5" id="deleteSlider">
                                        <div class="hotdog-handle" :style="{ left: filters.minScore + '%' }">
                                            <span class="hotdog-emoji">üå≠</span>
                                        </div>
                                    </div>
                                    <div class="slider-info">
                                        <span class="slider-info-text">
                                            <i class="fas fa-filter"></i>
                                            Showing {{ filteredMovies.length }} movies
                                        </span>
                                        <span class="slider-info-text">
                                            <i class="fas fa-hdd"></i>
                                            {{ calculateFilteredSpace() }} GB recoverable
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>Search:</label>
                                <input type="text" v-model="filters.search" placeholder="Search by title..." class="search-input">
                            </div>
                            <div class="filter-group">
                                <label>Sort By:</label>
                                <select v-model="filters.sortBy" class="sort-select">
                                    <option value="delete_score">Delete Score</option>
                                    <option value="file_size_gb">File Size</option>
                                    <option value="title">Title</option>
                                    <option value="year">Year</option>
                                    <option value="days_idle">Days Idle</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mass Selection Actions -->
                <div v-if="selectedMovies.length > 0 && !isAnalyzing" class="mass-actions-bar">
                    <div class="mass-actions-content">
                        <span class="selection-count">
                            <i class="fas fa-check-square"></i> {{ selectedMovies.length }} selected
                        </span>
                        <div class="mass-actions-buttons">
                            <button @click="addSelectedToUntouchables" class="btn btn-protect">
                                <i class="fas fa-star"></i> Protect Selected
                            </button>
                            <button @click="showMassDeleteConfirm = true" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i> Delete Selected
                            </button>
                            <button @click="clearSelection" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Movies Table / Grid -->
                <div v-if="filteredMovies.length > 0 && !isAnalyzing" class="movies-section">
                    <div class="card">
                        <div class="card-header">
                            <h2>Delete Candidates ({{ filteredMovies.length }} movies)</h2>
                            <div class="view-toggle">
                                <button @click="viewMode = 'table'" :class="{ active: viewMode === 'table' }">
                                    <i class="fas fa-table"></i> Table
                                </button>
                                <button @click="viewMode = 'grid'" :class="{ active: viewMode === 'grid' }">
                                    <i class="fas fa-th"></i> Grid
                                </button>
                            </div>
                        </div>

                        <!-- Table View -->
                        <div v-if="viewMode === 'table'" class="table-container">
                            <table class="movies-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" @change="toggleSelectAll" :checked="allSelected"></th>
                                        <th></th> <!-- Star -->
                                        <th>Rank</th>
                                        <th>Title</th>
                                        <th>Year</th>
                                        <th>Score</th>
                                        <th>Size (GB)</th>
                                        <th>Views</th>
                                        <th>Added</th>
                                        <th>Days Idle</th>
                                        <th>Ratings</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(movie, index) in paginatedMovies" :key="movie.rating_key"
                                        :class="[getScoreClass(movie.delete_score), { 'selected-row': isSelected(movie), 'untouchable': isUntouchable(movie) }]">
                                        <td>
                                            <input type="checkbox"
                                                   :checked="isSelected(movie)"
                                                   @change="toggleSelect(movie)"
                                                   :disabled="isUntouchable(movie)">
                                        </td>
                                        <td>
                                            <button @click="toggleUntouchable(movie)"
                                                    class="star-button"
                                                    :class="{ 'starred': isUntouchable(movie) }"
                                                    :title="isUntouchable(movie) ? 'Remove from Untouchables' : 'Protect this movie'">
                                                <i class="fas fa-star"></i>
                                            </button>
                                        </td>
                                        <td class="rank">{{ (currentPage - 1) * pageSize + index + 1 }}</td>
                                        <td class="title">
                                            <strong>{{ movie.title }}</strong>
                                        </td>
                                        <td>{{ movie.year || 'N/A' }}</td>
                                        <td class="score">
                                            <div class="score-badge" :class="getScoreBadgeClass(movie.delete_score)">
                                                {{ movie.delete_score }}
                                            </div>
                                        </td>
                                        <td>{{ movie.file_size_gb.toFixed(2) }}</td>
                                        <td>{{ movie.view_count }}</td>
                                        <td>{{ formatShortDate(movie.added_at) }}</td>
                                        <td>{{ calculateDaysIdle(movie) }}</td>
                                        <td>
                                            <div class="ratings">
                                                <span v-if="movie.omdb_imdb_rating" class="rating-badge imdb">
                                                    IMDb {{ movie.omdb_imdb_rating }}
                                                </span>
                                                <span v-if="movie.omdb_rotten_tomatoes" class="rating-badge rt">
                                                    RT {{ movie.omdb_rotten_tomatoes }}%
                                                </span>
                                                <span v-if="movie.tmdb_rating" class="rating-badge tmdb">
                                                    TMDb {{ movie.tmdb_rating }}
                                                </span>
                                            </div>
                                        </td>
                                        <td class="reason">{{ movie.delete_reason }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Grid View -->
                        <div v-if="viewMode === 'grid'" class="movies-grid">
                            <div v-for="(movie, index) in paginatedMovies" :key="movie.rating_key"
                                class="movie-card" :class="[getScoreClass(movie.delete_score), { 'selected-card': isSelected(movie), 'untouchable': isUntouchable(movie) }]">
                                <div class="movie-card-controls">
                                    <input type="checkbox"
                                           :checked="isSelected(movie)"
                                           @change="toggleSelect(movie)"
                                           :disabled="isUntouchable(movie)"
                                           class="movie-checkbox">
                                    <button @click="toggleUntouchable(movie)"
                                            class="star-button"
                                            :class="{ 'starred': isUntouchable(movie) }">
                                        <i class="fas fa-star"></i>
                                    </button>
                                </div>
                                <div class="movie-card-header">
                                    <div class="movie-rank">#{{ (currentPage - 1) * pageSize + index + 1 }}</div>
                                    <div class="movie-score" :class="getScoreBadgeClass(movie.delete_score)">
                                        {{ movie.delete_score }}
                                    </div>
                                </div>
                                <h3>{{ movie.title }}</h3>
                                <div class="movie-meta">
                                    <span><i class="fas fa-calendar"></i> {{ movie.year || 'N/A' }}</span>
                                    <span><i class="fas fa-hdd"></i> {{ movie.file_size_gb.toFixed(1) }} GB</span>
                                    <span><i class="fas fa-eye"></i> {{ movie.view_count }} views</span>
                                    <span><i class="fas fa-clock"></i> {{ calculateDaysIdle(movie) }} days idle</span>
                                </div>
                                <div class="movie-ratings">
                                    <span v-if="movie.omdb_imdb_rating" class="rating-badge imdb">
                                        IMDb {{ movie.omdb_imdb_rating }}
                                    </span>
                                    <span v-if="movie.omdb_rotten_tomatoes" class="rating-badge rt">
                                        RT {{ movie.omdb_rotten_tomatoes }}%
                                    </span>
                                    <span v-if="movie.tmdb_rating" class="rating-badge tmdb">
                                        TMDb {{ movie.tmdb_rating }}
                                    </span>
                                </div>
                                <p class="movie-reason">{{ movie.delete_reason }}</p>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                            <button @click="prevPage" :disabled="currentPage === 1" class="btn btn-sm">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span class="page-info">
                                Page {{ currentPage }} of {{ totalPages }}
                            </span>
                            <button @click="nextPage" :disabled="currentPage === totalPages" class="btn btn-sm">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Welcome Screen -->
                <div v-if="!stats && !isAnalyzing && !error" class="welcome-message">
                    <div class="card welcome-card">
                        <i class="fas fa-rocket"></i>
                        <h2>Welcome to PlexIQ v2!</h2>
                        <p class="hotdog-branding">üå≠ Made with MUSTARD by Team Hotdog üå≠</p>
                        <p>AI-powered analysis for your Plex media library</p>
                        <p>Click below to start scanning your collection</p>
                        <button @click="refreshAnalysis" class="btn btn-primary btn-lg">
                            <i class="fas fa-play"></i>
                            Start Analysis
                        </button>
                        <div class="welcome-disclaimer">
                            <i class="fas fa-info-circle"></i>
                            <span>Remember: PlexIQ doesn't backup your media. Always maintain your own backups!</span>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- The Untouchables Modal -->
        <div v-if="showUntouchablesModal" class="modal-overlay" @click.self="showUntouchablesModal = false">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-star"></i> The Untouchables</h2>
                    <button @click="showUntouchablesModal = false" class="close-button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="untouchables-description">
                        These movies are protected and <strong>cannot be deleted</strong>. Click the star on any movie to add it here.
                    </p>
                    <div v-if="untouchables.length === 0" class="empty-state">
                        <i class="fas fa-star"></i>
                        <p>No protected movies yet. Star your favorites to protect them!</p>
                    </div>
                    <div v-else class="untouchables-list">
                        <div v-for="movie in getUntouchableMovies()" :key="movie.rating_key" class="untouchable-item">
                            <div class="untouchable-info">
                                <strong>{{ movie.title }}</strong>
                                <span class="untouchable-meta">{{ movie.year }} ‚Ä¢ {{ movie.file_size_gb.toFixed(1) }} GB</span>
                            </div>
                            <button @click="toggleUntouchable(movie)" class="btn btn-sm btn-remove">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mass Delete Confirmation Modal -->
        <div v-if="showMassDeleteConfirm" class="modal-overlay" @click.self="showMassDeleteConfirm = false">
            <div class="modal modal-danger">
                <div class="modal-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> Confirm Mass Deletion</h2>
                    <button @click="showMassDeleteConfirm = false" class="close-button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="delete-warning">
                        <i class="fas fa-skull-crossbones"></i>
                        <h3>‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è</h3>
                        <p>You are about to <strong>permanently delete {{ selectedMovies.length }} movies</strong>.</p>
                        <p>This action is <strong>IRREVERSIBLE</strong> and will free up <strong>{{ calculateSelectedSpace() }} GB</strong>.</p>
                    </div>

                    <div class="confirmation-steps">
                        <div class="confirmation-step" :class="{ 'completed': deleteConfirmStep >= 1 }">
                            <input type="checkbox" v-model="deleteConfirm.step1" id="confirm1">
                            <label for="confirm1">I understand these files will be permanently deleted</label>
                        </div>
                        <div class="confirmation-step" :class="{ 'completed': deleteConfirmStep >= 2 }">
                            <input type="checkbox" v-model="deleteConfirm.step2" id="confirm2">
                            <label for="confirm2">I have backed up any movies I want to keep</label>
                        </div>
                        <div class="confirmation-step" :class="{ 'completed': deleteConfirmStep >= 3 }">
                            <input type="checkbox" v-model="deleteConfirm.step3" id="confirm3">
                            <label for="confirm3">I accept full responsibility for this action</label>
                        </div>
                    </div>

                    <div v-if="deleteConfirmStep === 3" class="password-verification">
                        <div class="delete-options">
                            <label class="delete-option-checkbox">
                                <input type="checkbox" v-model="deleteConfirm.deleteFiles" id="confirmDeleteFiles">
                                <span>
                                    <strong>Also delete physical files from disk</strong>
                                    <span class="option-hint">(Recommended - frees up actual space. Uncheck to only remove from Plex library.)</span>
                                </span>
                            </label>
                        </div>

                        <label>Enter your system password to confirm:</label>
                        <input type="password"
                               v-model="deleteConfirm.password"
                               placeholder="Enter password"
                               @keyup.enter="executeMassDelete"
                               class="password-input">
                        <p class="password-hint">This is an additional safety measure.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="showMassDeleteConfirm = false" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button @click="executeMassDelete"
                            class="btn btn-danger"
                            :disabled="!canExecuteDelete">
                        <i class="fas fa-trash-alt"></i> Delete {{ selectedMovies.length }} Movies
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>PlexIQ v2.0.0 | Built without ketchup by Team Hotdog üå≠</p>
                <p v-if="stats && stats.last_updated" class="last-updated">
                    Last updated: {{ formatDate(stats.last_updated) }}
                </p>
            </div>
        </footer>
    </div>

    <script src="app-v2.js"></script>
</body>
</html>
